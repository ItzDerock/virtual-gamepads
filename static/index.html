<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Rust Web Controller</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
        <style>
            :root {
                --btn-size: min(80px, 10vh);
            }

            body {
                margin: 0;
                padding: 0;
                background-color: #202020;
                color: white;
                font-family: sans-serif;
                overflow: hidden;
                touch-action: none; /* Critical: disables browser zoom/scroll gestures */
                user-select: none;
                -webkit-user-select: none;
                display: flex;
                height: 100vh;
                width: 100vw;
            }

            /* --- LEFT ZONE: Dynamic Joystick --- */
            #zone_left {
                width: 50%;
                height: 100%;
                position: relative;
                /* distinct background hint */
                background: linear-gradient(to right, #252525, #202020);
                border-right: 1px solid #333;
            }

            /* --- RIGHT ZONE: Diamond Buttons --- */
            #zone_right {
                width: 50%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* The Diamond Grid Container */
            .button-grid {
                display: grid;
                grid-template-columns: var(--btn-size) var(--btn-size) var(
                        --btn-size
                    ); /* 3 columns */
                grid-template-rows: var(--btn-size) var(--btn-size) var(
                        --btn-size
                    ); /* 3 rows */
                gap: 10px;
            }

            /* Button Styling */
            .btn {
                width: var(--btn-size);
                height: var(--btn-size);
                border-radius: 50%;
                border: 4px solid #444;
                background: #333;
                color: #ddd;
                font-size: 28px;
                font-weight: bold;
                display: flex;
                justify-content: center;
                align-items: center;
                box-shadow: 0 6px 0 #111;
                transition:
                    transform 0.05s,
                    box-shadow 0.05s;
                cursor: pointer;
            }

            /* Press Animation */
            .btn:active,
            .btn.pressed {
                transform: translateY(6px);
                box-shadow: 0 0 0 #111;
                background: #444;
            }

            /* Grid Positioning for Diamond Shape */
            /* Row / Column start / Row end / Column end */
            #btn-y {
                grid-area: 1 / 2 / 2 / 3;
                border-color: #55552a;
                color: #ffff5c;
            } /* Top (Yellow) */
            #btn-x {
                grid-area: 2 / 1 / 3 / 2;
                border-color: #2a2a55;
                color: #5c5cff;
            } /* Left (Blue) */
            #btn-b {
                grid-area: 2 / 3 / 3 / 4;
                border-color: #552a2a;
                color: #ff5c5c;
            } /* Right (Red) */
            #btn-a {
                grid-area: 3 / 2 / 4 / 3;
                border-color: #2a552a;
                color: #5cff5c;
            } /* Bottom (Green) */

            #status {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                padding: 5px 15px;
                background: rgba(0, 0, 0, 0.6);
                border-radius: 20px;
                font-size: 14px;
                pointer-events: none;
                z-index: 10;
            }
        </style>
    </head>
    <body>
        <div id="status">Connecting...</div>

        <div id="zone_left"></div>

        <div id="zone_right">
            <div class="button-grid">
                <div class="btn" id="btn-y" data-code="308">Y</div>
                <div class="btn" id="btn-x" data-code="307">X</div>
                <div class="btn" id="btn-b" data-code="305">B</div>
                <div class="btn" id="btn-a" data-code="304">A</div>
            </div>
        </div>

        <script>
            // read or create a unique uuidv4 from localstorage
            let clientId = localStorage.getItem("clientId");
            if (!clientId) {
                clientId = crypto.randomUUID();
                localStorage.setItem("clientId", clientId);
            }

            let pingSentAt = 0;
            const wsUrl = `ws://${window.location.hostname}:3000/ws?client_id=${clientId}`;
            let ws = new WebSocket(wsUrl);
            const statusDiv = document.getElementById("status");

            ws.onopen = () => {
                statusDiv.textContent = "Connected";
                statusDiv.style.color = "#5cff5c";
            };
            ws.onclose = () => {
                statusDiv.textContent = "Disconnected";
                statusDiv.style.color = "#ff5c5c";
            };

            function send(data) {
                if (ws.readyState === WebSocket.OPEN)
                    ws.send(JSON.stringify(data));
            }

            const joyManager = nipplejs.create({
                zone: document.getElementById("zone_left"), // Only active in left half
                mode: "dynamic", // Creates joystick where you tap
                color: "white",
                size: 120,
                threshold: 0.1, // Sensitivity
            });

            joyManager.on("move", function (evt, data) {
                if (data.vector) {
                    // Scale normalized vector (-1 to 1) to Int16 (-32768 to 32767)
                    const x = Math.floor(data.vector.x * 32767);
                    const y = Math.floor(data.vector.y * -32767); // Invert Y for standard flight/gamepad controls
                    send({ kind: "axis", code: 0, value: x });
                    send({ kind: "axis", code: 1, value: y });
                }
            });

            joyManager.on("end", function () {
                // Reset to center when finger lifts
                send({ kind: "axis", code: 0, value: 0 });
                send({ kind: "axis", code: 1, value: 0 });
            });

            /** Register all button events */
            document.querySelectorAll(".btn").forEach((btn) => {
                const code = parseInt(btn.getAttribute("data-code"));

                const press = (e) => {
                    e.preventDefault();
                    if (!btn.classList.contains("pressed")) {
                        btn.classList.add("pressed");
                        if (navigator.vibrate) navigator.vibrate(15);
                        send({ kind: "btn", code: code, value: 1 });
                    }
                };

                const release = (e) => {
                    e.preventDefault();
                    if (btn.classList.contains("pressed")) {
                        btn.classList.remove("pressed");
                        send({ kind: "btn", code: code, value: 0 });
                    }
                };

                btn.addEventListener("touchstart", press, { passive: false });
                btn.addEventListener("touchend", release, { passive: false });
                btn.addEventListener("mousedown", press);
                btn.addEventListener("mouseup", release);
                btn.addEventListener("mouseleave", release);
            });

            // enter fullscreen if status tapped
            statusDiv.addEventListener("click", () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            });

            // every 5 seconds, send a ping to keep the connection alive
            setInterval(() => {
                send({ kind: "ping" });
                pingSentAt = Date.now();
            }, 5000);

            // listen for pong responses to measure latency
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.kind === "pong") {
                    const latency = Date.now() - pingSentAt;
                    statusDiv.textContent = `Connected - ${latency} ms`;
                }
            };
        </script>
    </body>
</html>
